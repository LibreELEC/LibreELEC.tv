From 62cb60aab19771a1005ea71f6b8b6a06515ed226 Mon Sep 17 00:00:00 2001
From: Aman Gupta <aman@tmm1.net>
Date: Thu, 12 Sep 2019 10:26:03 -0700
Subject: [PATCH 49/59] avcodec/v4l2_m2m_dec: reorg flow after previous commit

Signed-off-by: Aman Gupta <aman@tmm1.net>
---
 libavcodec/v4l2_m2m_dec.c | 12 ++++++------
 1 file changed, 6 insertions(+), 6 deletions(-)

diff --git a/libavcodec/v4l2_m2m_dec.c b/libavcodec/v4l2_m2m_dec.c
index d79a2e5842..bc0b71d262 100644
--- a/libavcodec/v4l2_m2m_dec.c
+++ b/libavcodec/v4l2_m2m_dec.c
@@ -143,14 +143,14 @@ static int v4l2_receive_frame(AVCodecContext *avctx, AVFrame *frame)
         goto dequeue;
 
     ret = ff_v4l2_context_enqueue_packet(output, &s->buf_pkt);
-    if (ret != AVERROR(EAGAIN))
-        av_packet_unref(&s->buf_pkt);
-    if (ret < 0) {
-        if (ret != AVERROR(EAGAIN))
-           return ret;
-
+    if (ret == AVERROR(EAGAIN)) {
         /* no input buffers available, continue dequeing */
     } else {
+        av_packet_unref(&s->buf_pkt);
+
+        if (ret < 0)
+            return ret;
+
         ret = v4l2_try_start(avctx);
         if (ret) {
             /* cant recover */
-- 
2.21.0

