#!/bin/sh

# SPDX-License-Identifier: GPL-2.0-or-later
# Copyright (C) 2009-2014 Stephan Raue (stephan@openelec.tv)

# creating initial settings file
  if [ ! -f /storage/.cache/connman/settings ]; then
    mkdir -p /storage/.cache/connman
      cp /usr/share/connman/settings /storage/.cache/connman
  fi

# set variable for connman main.conf location
  if [ -f /storage/.config/connman_main.conf ]; then
    export CONNMAN_MAIN="--config=/storage/.config/connman_main.conf"
  else
    export CONNMAN_MAIN="--config=/etc/connman/main.conf"
  fi

# find network device used for given NFS mount
get_nfs_device() {
  nfs_ip=$(grep -E "^[^ ]+ $1 " /proc/mounts | head -1 | cut -d ':' -f 1)
  [ -z "$nfs_ip" ] && return
  NFS_DEV=$(ip route get to "$nfs_ip" | grep -o -E "\\<dev \\w+" | head -1 | sed -e "s/^dev //")
}

# in case of netboot tell connman to ignore the network device
# used for NFS mount as it's already configured by the kernel
NFS_DEV=""
[ -f /dev/.flash_netboot ] && get_nfs_device /flash
[ -z "$NFS_DEV" -a -f /dev/.storage_netboot ] && get_nfs_device /storage
[ -n "$NFS_DEV" ] && CONNMAN_MAIN="$CONNMAN_MAIN -I $NFS_DEV"

# setup resolv.conf.
# Allow static user configuration and use kernel provided resolver
# info in case of netboot.
if [ -f /storage/.config/resolv.conf ]; then
  ln -sf /storage/.config/resolv.conf /run/resolv.conf
elif [ -n "$NFS_DEV" -a -e /proc/net/pnp ]; then
  ln -sf /proc/net/pnp /run/resolv.conf
else
  ln -sf /run/connman/resolv.conf /run/resolv.conf
fi
