# SPDX-License-Identifier: GPL-2.0-or-later
# Copyright (C) 2018-present Team LibreELEC (https://libreelec.tv)

DTB_BLOBS=($(ls arch/$TARGET_KERNEL_ARCH/boot/dts/amlogic/*.dtb 2>/dev/null || true))
DTB_BLOBS_COUNT="${#DTB_BLOBS[@]}"
DTB_BLOB_OUTPUT="arch/$TARGET_KERNEL_ARCH/boot/dtb.img"
ANDROID_BOOTIMG_SECOND="--second $DTB_BLOB_OUTPUT"

if [ "$DTB_BLOBS_COUNT" -gt 1 ]; then
  $TOOLCHAIN/bin/dtbTool -o arch/$TARGET_KERNEL_ARCH/boot/dtb.img -p scripts/dtc/ arch/$TARGET_KERNEL_ARCH/boot/dts/amlogic/
elif [ "$DTB_BLOBS_COUNT" -eq 1 ]; then
  cp -PR $DTB_BLOBS $DTB_BLOB_OUTPUT
else
  ANDROID_BOOTIMG_SECOND=""
fi

LDFLAGS="" mkbootimg --kernel arch/$TARGET_KERNEL_ARCH/boot/$KERNEL_TARGET --ramdisk $BUILD/image/initramfs.cpio \
  $ANDROID_BOOTIMG_SECOND $ANDROID_BOOTIMG_OPTIONS --output arch/$TARGET_KERNEL_ARCH/boot/boot.img
