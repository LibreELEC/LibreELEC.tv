From 267247d079126e9e8923ebff291830b9beb533a6 Mon Sep 17 00:00:00 2001
From: Lukas Rusak <lorusak@gmail.com>
Date: Tue, 5 Jun 2018 20:09:56 -0700
Subject: [PATCH] settings: add setting for PRIME renderer type

---
 .../resource.language.en_gb/resources/strings.po   | 23 ++++++++++++++++++++++
 system/settings/gbm.xml                            | 17 ++++++++++++++++
 .../HwDecRender/RendererDRMPRIME.cpp               |  9 ++++++++-
 3 files changed, 48 insertions(+), 1 deletion(-)

diff --git a/addons/resource.language.en_gb/resources/strings.po b/addons/resource.language.en_gb/resources/strings.po
index 4d4d1265d580..0066363390bf 100644
--- a/addons/resource.language.en_gb/resources/strings.po
+++ b/addons/resource.language.en_gb/resources/strings.po
@@ -7185,6 +7185,29 @@ msgctxt "#13461"
 msgid "Enable this option to use hardware acceleration for the HEVC codec. If disabled the CPU will be used instead."
 msgstr ""
 
+#: system/settings/settings.xml
+msgctxt "#13462"
+msgid "PRIME Renderer"
+msgstr ""
+
+#. Description of setting with label #13462 "Use Prime Renderer"
+#: system/settings/settings.xml
+msgctxt "#13463"
+msgid "This option switches between Direct and OpenGLES Rendering."
+msgstr ""
+
+#. adjust refreshrate
+#: system/settings/settings.xml
+msgctxt "#13464"
+msgid "Direct"
+msgstr ""
+
+#. adjust refreshrate
+#: system/settings/settings.xml
+msgctxt "#13465"
+msgid "OpenGLES"
+msgstr ""
+
 #empty strings from id 13462 to 13504
 
 #: system/settings/settings.xml
diff --git a/system/settings/gbm.xml b/system/settings/gbm.xml
index 66a4b44482c2..a223be5e6c7c 100644
--- a/system/settings/gbm.xml
+++ b/system/settings/gbm.xml
@@ -8,6 +8,23 @@
           <default>true</default>
           <control type="toggle" />
         </setting>
+        <setting id="videoplayer.useprimerenderer" type="integer" label="13462" help="13463">
+          <visible>true</visible>
+          <dependencies>
+            <dependency type="enable">
+              <condition setting="videoplayer.useprimedecoder" operator="is">true</condition>
+            </dependency>
+          </dependencies>
+          <level>2</level>
+          <default>0</default>
+          <constraints>
+            <options>
+              <option label="13464">0</option> <!-- DIRECT -->
+              <option label="13465">1</option> <!-- GLES -->
+            </options>
+          </constraints>
+          <control type="spinner" format="string" />
+        </setting>
       </group>
     </category>
   </section>
diff --git a/xbmc/cores/VideoPlayer/VideoRenderers/HwDecRender/RendererDRMPRIME.cpp b/xbmc/cores/VideoPlayer/VideoRenderers/HwDecRender/RendererDRMPRIME.cpp
index 961f38d84197..beb63eee9a49 100644
--- a/xbmc/cores/VideoPlayer/VideoRenderers/HwDecRender/RendererDRMPRIME.cpp
+++ b/xbmc/cores/VideoPlayer/VideoRenderers/HwDecRender/RendererDRMPRIME.cpp
@@ -23,8 +23,12 @@
 #include "cores/VideoPlayer/VideoRenderers/RenderCapture.h"
 #include "cores/VideoPlayer/VideoRenderers/RenderFactory.h"
 #include "cores/VideoPlayer/VideoRenderers/RenderFlags.h"
+#include "ServiceBroker.h"
+#include "settings/Settings.h"
 #include "utils/log.h"
 
+const std::string SETTING_VIDEOPLAYER_USEPRIMERENDERER = "videoplayer.useprimerenderer";
+
 static CWinSystemGbmGLESContext *m_pWinSystem;
 
 CRendererDRMPRIME::CRendererDRMPRIME(std::shared_ptr<CDRMUtils> drm)
@@ -40,7 +44,10 @@ CRendererDRMPRIME::~CRendererDRMPRIME()
 CBaseRenderer* CRendererDRMPRIME::Create(CVideoBuffer* buffer)
 {
   if (buffer && dynamic_cast<CVideoBufferDRMPRIME*>(buffer))
-    return new CRendererDRMPRIME(m_pWinSystem->m_DRM);
+  {
+    if (CServiceBroker::GetSettings().GetInt(SETTING_VIDEOPLAYER_USEPRIMERENDERER) == 0)
+      return new CRendererDRMPRIME(m_pWinSystem->m_DRM);
+  }
 
   return nullptr;
 }
